{"version":3,"file":"reflectionForm.min.js","sources":["../src/reflectionForm.js"],"sourcesContent":["import Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst loadForm = (contextid, formData) => {\n\n    if (typeof formData === \"undefined\") {\n        formData = {}\n    }\n\n    var params = { jsonformdata: JSON.stringify(formData)};\n\n    // Check where the form will be displayed. If its in the submissions table, we only have to show\n    // the text. If its the student view, then display the form.\n\n    if (document.getElementById('page-mod-assign-grading')) {\n        renderReflectionInSubmissionTable();\n\n    } else {\n\n        Fragment.loadFragment('assignsubmission_reflection', 'reflectionpanel', contextid, params).done(function (html, js) {\n            $(document.querySelector('.reflection-form-container')).fadeOut(\"fast\", function () {\n                Templates.replaceNodeContents($(document.querySelector('.reflection-form-container')), html, js);\n\n                $(document.querySelector('.reflection-form-container')).fadeIn(\"fast\");\n                $(document.querySelector('.reflection-form-container form  #id_submitbutton')).on('click', submitFormAjax.bind(this));\n                document.getElementById('id_submission').value = document.querySelector('.reflection-form-container').getAttribute('data-itemid');\n                document.getElementById('id_assignment').value = document.querySelector('.reflection-form-container').getAttribute('data-assignment');\n            });\n\n        }).fail(function (response) {\n            console.log(response);\n        })\n    }\n\n\n}\n\nconst submitFormAjax = (e) => {\n    // We don't want to do a real form submission.\n    e.preventDefault();\n\n    var formData = $(document.querySelector('.reflection-form-container form')).serialize();\n    var contextid = document.querySelector(\".reflection-form-container\").getAttribute('data-contextid');\n    var canedit = document.querySelector(\".reflection-form-container\").getAttribute('data-editing-enable');\n\n    Ajax.call([{\n        methodname: 'assignsubmission_reflection_reflection_form',\n        args: {\n            contextid: contextid,\n            jsonformdata: JSON.stringify(formData),\n            canedit: canedit\n        },\n        done: function (response) {\n            console.log(response);\n            responseReflectionDisplay(response);\n        },\n        fail: function (reason) {\n            console.log(reason);\n\n        }\n    }]);\n\n}\n\nconst responseReflectionDisplay = (response) => {\n    console.log(JSON.parse(response));\n    response = JSON.parse(response);\n\n    switch (response.result) {\n        case \"FAIL\":\n            if (document.querySelector('.cgs-reflection-fail-alert') == null) {\n                const alert1 = \"<div class='alert alert-danger cgs-reflection-alert cgs-reflection-fail-alert' role='alert'>There was a problem when saving the reflection. Please try again later</div>\"\n                $(document.querySelector('.reflection-form-container form')).after(alert1);\n            }\n            fadeAlert(\".cgs-reflection-fail-alert\");\n            break;\n        case \"EMPTY\":\n            if (document.querySelector('.cgs-reflection-empty-alert') == null) {\n                const alert2 = \"<div class='alert alert-danger cgs-reflection-alert cgs-reflection-empty-alert' role='alert'>The reflection cannot be empty</div>\"\n                $(document.querySelector('.reflection-form-container form')).after(alert2);\n            }\n            fadeAlert(\".cgs-reflection-empty-alert\");\n            break;\n        case \"SUCCESS_NON_EDITABLE\":\n            $(document.querySelector('.reflection-form-container')).fadeOut(\"fast\", function () {\n                $(document.querySelector('.reflection-form-container')).replaceWith(response.reflection);\n                $(document.querySelector('.reflection-form-container')).fadeIn(\"fast\");\n            });\n            break;\n        case \"SUCCESS_EDITABLE\":\n            loadForm(document.querySelector(\".reflection-form-container\").getAttribute('data-contextid'), response.serialiseddata);\n            if (document.querySelector('.cgs-reflection-editing') == null) {\n                const alert3 = `<div class='alert alert-success alert-dismissible cgs-reflection-alert cgs-reflection-editing'>\n                                <button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button>\n                                <strong>Success!</strong> Reflection saved.\n                              </div>`\n                $(document.querySelector('.reflection-form-container form')).after(alert3);\n\n                // Fade it after a while.\n                fadeAlert(\".cgs-reflection-editing\");\n\n            }\n            break;\n\n    }\n}\n\nconst fadeAlert = (alert) => {\n    $(alert).fadeOut(5000);\n}\n\nconst renderReflectionInSubmissionTable = () => {\n\n    if (document.querySelector('.reflection-form-container') == null) {\n        return;\n    }\n    // Add the truncate css class\n    $('div.reflection-form-container').addClass('text-truncate');\n\n    const container = document.querySelector('.reflection-form-container');\n    const submission = container.getAttribute('data-itemid');\n    const assignment = container.getAttribute('data-assignment');\n    const context = container.getAttribute('data-contextid');\n\n    Ajax.call([{\n        methodname: 'assignsubmission_reflection_get_reflection',\n        args: {\n            submission: submission,\n            assignment: assignment,\n            context:context\n        },\n        done: function (response) {\n            console.log(response);\n            document.querySelector('.reflection-form-container').innerHTML = response;\n\n            $('#more').on('click', function(e) {\n                e.stopPropagation();\n                if ($('div.reflection-form-container').hasClass('text-truncate')) {\n\n                    $('div.reflection-form-container').removeClass('text-truncate');\n                    $('.assignsubmission_reflection-plus').removeClass('fa-plus');\n                    $('.assignsubmission_reflection-plus').addClass('fa-minus');\n                    document.getElementById('more').setAttribute('title', 'View summary');\n                    $('div.reflection-form-container').css({\n                        'height': 'auto'\n                    })\n                } else {\n                    document.getElementById('more').setAttribute('title', 'View full');\n\n                    $('div.reflection-form-container').addClass('text-truncate');\n                    $('.assignsubmission_reflection-plus').removeClass('fa-minus');\n                    $('.assignsubmission_reflection-plus').addClass('fa-plus');\n\n                }\n            });\n        },\n        fail: function (reason) {\n            console.log(reason);\n\n        }\n    }]);\n}\n\nexport const init = (contextid, formData, nonEditable = false) => {\n    if (nonEditable) {\n        $('#view-reflection').on('click', function(e) {\n            e.stopPropagation();\n            if ($('.assignsubmission_reflection-non-editable-plus').hasClass('fa-plus')) {\n                $('.assignsubmission_reflection-non-editable-plus').removeClass('fa-plus');\n                $('.assignsubmission_reflection-non-editable-plus').addClass('fa-minus');\n                $('.summary_assignsubmission_reflection').removeClass('view-summary');\n                $('.summary_assignsubmission_reflection').addClass('view-full');\n                document.getElementById('view-reflection').setAttribute('title', 'View summary');\n\n            } else {\n                document.getElementById('view-reflection').setAttribute('title', 'View full');\n\n                $('.assignsubmission_reflection-non-editable-plus').removeClass('fa-minus');\n                $('.assignsubmission_reflection-non-editable-plus').removeClass('view-full');\n                $('.assignsubmission_reflection-non-editable-plus').addClass('fa-plus');\n                $('.summary_assignsubmission_reflection').addClass('view-summary');\n\n\n            }\n        });\n    } else {\n        loadForm(contextid, formData);\n    }\n}\n\n\n"],"names":["loadForm","contextid","formData","params","jsonformdata","JSON","stringify","document","getElementById","renderReflectionInSubmissionTable","loadFragment","done","html","js","querySelector","fadeOut","replaceNodeContents","fadeIn","on","submitFormAjax","bind","this","value","getAttribute","fail","response","console","log","e","preventDefault","serialize","canedit","call","methodname","args","responseReflectionDisplay","reason","parse","result","after","fadeAlert","replaceWith","reflection","serialiseddata","alert","addClass","container","submission","assignment","context","innerHTML","stopPropagation","hasClass","removeClass","setAttribute","css","nonEditable"],"mappings":"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"}