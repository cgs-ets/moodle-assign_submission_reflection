{"version":3,"file":"reflectionForm.min.js","sources":["../src/reflectionForm.js"],"sourcesContent":["import Fragment from 'core/fragment';\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport $ from 'jquery';\n\nconst loadForm = (contextid, formData) => {\n\n    if (typeof formData === \"undefined\") {\n        formData = {}\n    }\n\n    var params = { jsonformdata: JSON.stringify(formData) };\n\n    // Check where the form will be displayed.\n    // If its in the submissions table, parentview or grader view, we only have to show the text.\n    //If its the student view, then display the form.\n\n    if (document.getElementById('page-mod-assign-grading')) {\n        renderReflectionInSubmissionTable();\n\n    } else if (document.getElementById('page-mod-assign-grader')\n        || iniFrame()) {\n        assignsubmission_reflection_get_reflection(document.querySelector('.reflection-form-container'), true);\n    } else {\n        Fragment.loadFragment('assignsubmission_reflection', 'reflectionpanel', contextid, params).done(function (html, js) {\n            $(document.querySelector('.reflection-form-container')).fadeOut(\"fast\", function () {\n                Templates.replaceNodeContents($(document.querySelector('.reflection-form-container')), html, js);\n\n                $(document.querySelector('.reflection-form-container')).fadeIn(\"fast\");\n                $(document.querySelector('.reflection-form-container form  #id_submitbutton')).on('click', submitFormAjax.bind(this));\n                document.getElementById('id_submission').value = document.querySelector('.reflection-form-container').getAttribute('data-itemid');\n                document.getElementById('id_assignment').value = document.querySelector('.reflection-form-container').getAttribute('data-assignment');\n            });\n\n        }).fail(function (response) {\n            console.log(response);\n        })\n    }\n\n\n}\n\nconst submitFormAjax = (e) => {\n    // We don't want to do a real form submission.\n    e.preventDefault();\n\n    var formData = $(document.querySelector('.reflection-form-container form')).serialize();\n    var contextid = document.querySelector(\".reflection-form-container\").getAttribute('data-contextid');\n    var canedit = document.querySelector(\".reflection-form-container\").getAttribute('data-editing-enable');\n    var userid = document.querySelector(\".reflection-form-container\").getAttribute('data-userid');\n\n    Ajax.call([{\n        methodname: 'assignsubmission_reflection_reflection_form',\n        args: {\n            contextid: contextid,\n            jsonformdata: JSON.stringify(formData),\n            canedit: canedit,\n            userid: userid\n        },\n        done: function (response) {\n            responseReflectionDisplay(response);\n        },\n        fail: function (reason) {\n            console.log(reason);\n        }\n    }]);\n\n}\n\nconst responseReflectionDisplay = (response) => {\n    response = JSON.parse(response);\n\n    switch (response.result) {\n        case \"FAIL\":\n            if (document.querySelector('.cgs-reflection-fail-alert') == null) {\n                const alert1 = \"<div class='alert alert-danger cgs-reflection-alert cgs-reflection-fail-alert' role='alert'>There was a problem when saving the reflection. Please try again later</div>\"\n                $(document.querySelector('.reflection-form-container form')).after(alert1);\n            }\n            fadeAlert(\".cgs-reflection-fail-alert\");\n            break;\n        case \"EMPTY\":\n            if (document.querySelector('.cgs-reflection-empty-alert') == null) {\n                const alert2 = \"<div class='alert alert-danger cgs-reflection-alert cgs-reflection-empty-alert' role='alert'>The reflection cannot be empty</div>\"\n                $(document.querySelector('.reflection-form-container form')).after(alert2);\n            }\n            fadeAlert(\".cgs-reflection-empty-alert\");\n            break;\n        case \"SUCCESS_NON_EDITABLE\":\n            $(document.querySelector('.reflection-form-container')).fadeOut(\"fast\", function () {\n                $(document.querySelector('.reflection-form-container')).replaceWith(response.reflection);\n                $(document.querySelector('.reflection-form-container')).fadeIn(\"fast\");\n            });\n            break;\n        case \"SUCCESS_EDITABLE\":\n            loadForm(document.querySelector(\".reflection-form-container\").getAttribute('data-contextid'), response.serialiseddata);\n            if (document.querySelector('.cgs-reflection-editing') == null) {\n                const alert3 = `<div class='alert alert-success alert-dismissible cgs-reflection-alert cgs-reflection-editing'>\n                                <button type=\"button\" class=\"close\" data-dismiss=\"alert\">&times;</button>\n                                <strong>Success!</strong> Reflection saved.\n                              </div>`\n                $(document.querySelector('.reflection-form-container form')).after(alert3);\n\n                // Fade it after a while.\n                fadeAlert(\".cgs-reflection-editing\");\n\n            }\n            break;\n\n    }\n}\n\nconst fadeAlert = (alert) => {\n    $(alert).fadeOut(5000);\n}\n\nconst renderReflectionInSubmissionTable = () => {\n\n    // Get the header of reflection. it has a class like header c9.\n    //that c9 matches the cell where the reflection goes.The td class is cell c9\n    const reflectionTh = Array.from(document.querySelector('table thead tr').children).filter(th => {\n        if (th.innerHTML.includes('Reflection')) {\n            return th;\n        }\n\n    });\n\n    let cellNumber = reflectionTh[0].getAttribute('class').split(' ');\n    cellNumber = cellNumber[cellNumber.length - 1];\n\n    const submissionsTableCells = Array.from(document.querySelectorAll('table tbody tr td'));\n\n    submissionsTableCells.forEach(td => {\n        if (td.getAttribute('class').includes(cellNumber)) {\n\n            const container = td.querySelector('.reflection-form-container');\n\n            if (container != null) {\n                assignsubmission_reflection_get_reflection(container);\n            } else {\n                td.innerHTML = '<span class = \"reflectionsubmissionstatus\">No Reflection</span>'\n            }\n\n        }\n    });\n\n}\n\nconst assignsubmission_reflection_get_reflection = (container, fromGraderView = false) => {\n\n    if (document.querySelector('.reflection-form-container') == null) {\n        return;\n    }\n    // Add the truncate css class\n    $('div.reflection-form-container').addClass('text-truncate');\n\n    // const container = document.querySelector('.reflection-form-container');\n    const submission = container.getAttribute('data-itemid');\n    const assignment = container.getAttribute('data-assignment');\n    const context = container.getAttribute('data-contextid');\n    const userid = container.getAttribute('data-userid');\n\n    Ajax.call([{\n        methodname: 'assignsubmission_reflection_get_reflection',\n        args: {\n            submission: submission,\n            assignment: assignment,\n            context: context,\n            userid: userid\n        },\n        done: function (response) {\n\n            if (fromGraderView) {\n                document.querySelector('.reflection-form-container').innerHTML = response;\n            } else {\n                document.querySelector(`[data-userid=\"${userid}\"]`).innerHTML = response;\n            }\n\n            controlViewFull(userid);\n        },\n        fail: function (reason) {\n            console.log(reason);\n\n        }\n    }]);\n}\n\nconst controlViewFull = (userid) => {\n\n    $(`#more-${userid}`).on('click', function (e) {\n        e.stopPropagation();\n\n        if ($(`.reflection-form-container[data-userid = \"${userid}\"]`).hasClass('text-truncate')) {\n\n            $(`.reflection-form-container[data-userid = \"${userid}\"]`).removeClass('text-truncate');\n            $(`#more-${userid} > i`).removeClass('fa-plus');\n            $(`#more-${userid} > i`).addClass('fa-minus');\n            document.getElementById(`more-${userid}`).setAttribute('title', 'View summary');\n            $(`.reflection-form-container[data-userid = \"${userid}\"]`).css({\n                'height': 'auto'\n            })\n        } else {\n            document.getElementById(`more-${userid}`).setAttribute('title', 'View full');\n            $(`.reflection-form-container[data-userid = \"${userid}\"]`).addClass('text-truncate');\n            $(`#more-${userid} > i`).removeClass('fa-minus');\n            $(`#more-${userid} > i`).addClass('fa-plus');\n\n        }\n    });\n}\n// Check if the view is inside an Iframe, it is, its because we are coming from the parentview\nconst iniFrame = () => {\n    return window.self !== window.top;\n}\n\nexport const init = (contextid, formData, nonEditable = false, userid) => {\n    // Check that you are in the gr ader view\n    if (document.getElementById('page-mod-assign-grader') != null\n        && document.querySelector('span.reflectionsubmissionstatus') != null) {\n        document.querySelector('span.reflectionsubmissionstatus').removeAttribute('hidden');\n    }\n\n    if (nonEditable) {\n        controlViewFull(userid);\n    } else {\n        loadForm(contextid, formData);\n    }\n}\n\n\n"],"names":["loadForm","contextid","formData","params","jsonformdata","JSON","stringify","document","getElementById","renderReflectionInSubmissionTable","iniFrame","assignsubmission_reflection_get_reflection","querySelector","loadFragment","done","html","js","fadeOut","replaceNodeContents","fadeIn","on","submitFormAjax","bind","this","value","getAttribute","fail","response","console","log","e","preventDefault","serialize","canedit","userid","call","methodname","args","responseReflectionDisplay","reason","parse","result","after","fadeAlert","replaceWith","reflection","serialiseddata","alert","cellNumber","Array","from","children","filter","th","innerHTML","includes","split","length","querySelectorAll","forEach","td","container","fromGraderView","addClass","submission","assignment","context","controlViewFull","stopPropagation","hasClass","removeClass","setAttribute","css","window","self","top","nonEditable","removeAttribute"],"mappings":"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"}